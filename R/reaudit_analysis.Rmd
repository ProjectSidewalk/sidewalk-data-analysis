---
title: "Re-Audit Analysis"
author: "Mikey Saugstad"
date: "January 17, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(RPostgreSQL)
library(dplyr)
library(ggplot2)
```

```{r connect, echo=FALSE}
pw <- {'sidewalk'}
drv <- dbDriver("PostgreSQL")
con <- dbConnect(drv, dbname = "sidewalk",
                 host = "localhost", port = 5432,
                 user = "sidewalk", password = pw)
rm(pw)
# dbExistsTable(con, "audit_task")
```


```{r reading.data, echo=FALSE, include=FALSE}
labels <-
  dbGetQuery(con,
            'SELECT label_id, user_id, label_type_id, completed, audit_task.audit_task_id,
                    street_edge.street_edge_id, ST_LENGTH(ST_TRANSFORM(geom,26918))
            FROM street_edge
            INNER JOIN audit_task
            ON street_edge.street_edge_id = audit_task.street_edge_id
            INNER JOIN label 
            ON audit_task.audit_task_id = label.audit_task_id
            WHERE label.deleted = FALSE
            AND street_edge.deleted = FALSE')
total.street.distance <-
  dbGetQuery(con,
             'SELECT SUM(ST_LENGTH(ST_TRANSFORM(geom,26918)))
             FROM street_edge
             WHERE deleted = FALSE')
dbDisconnect(con)
```

```{r transforming.data, echo=FALSE, warning=FALSE}
label.counts <-
  labels %>%
  # filter(label_type_id != 7) %>%
  mutate(user_id = factor(user_id)) %>%
  # count(user_id)
  group_by(user_id) %>%
  summarize_at(vars(label_id), n_distinct)

# completed.audit.counts <-
#   labels %>%
#   mutate(user_id = factor(user_id)) %>%
#   filter(completed == TRUE) %>%
#   group_by(user_id) %>%
#   summarize_at(vars(audit_task_id), n_distinct)

audit.length <-
  labels %>%
  mutate(user_id = factor(user_id)) %>%
  filter(completed == TRUE) %>%
  group_by(user_id) %>%
  distinct(audit_task_id, .keep_all = TRUE) %>%
  summarize_at(vars(st_length), sum)

counts <-
  audit.length %>%
  inner_join(label.counts, by = 'user_id') %>%
  mutate(labels.per.100m = 100 * label_id / st_length)

mikey.freq <- (counts %>% filter(user_id == '9efaca05-53bb-492e-83ab-2b47219ee863'))$labels.per.100m
jon.freq <- (counts %>% filter(user_id == '49787727-e427-4835-a153-9af6a83d1ed1'))$labels.per.100m

dist.after.removal <-
  Vectorize(
    function(labels.per.100m.threshold, labels.threshold) {
      good.users <-
        counts %>%
        filter(labels.per.100m >= labels.per.100m.threshold) %>%
        filter(label_id >= labels.threshold)
      
      new.total.dist <-
        labels %>%
        filter(completed == TRUE) %>%
        filter(user_id %in% good.users$user_id) %>%
        distinct(street_edge_id, .keep_all = TRUE) %>%
        summarize_at(vars(st_length), sum)
      new.total.dist[[1]]
    }
  )

total.dist <- (
  labels %>%
  filter(completed == TRUE) %>%
  distinct(street_edge_id, .keep_all = TRUE) %>%
  summarize_at(vars(st_length), sum)
)[[1]]

dist.left <-
  data.frame(threshold = seq(0, 15, by = 0.05)) %>%
  mutate(dist.left = dist.after.removal(threshold, 0))
```

This graph shows what percentage of DC we would have to re-audit (in terms of distance), given different labels/100 meter thresholds for users. For example at x = 5.0, I looked at what our completion percentage would be if we removed the audits from all users who have a labeling frequency of less than 5 labels per 100 meters. For reference, Mikey's label frequency is 6.5 labels/100m, and Jon's is 10.1 labels/100m. I added lines vertical lines on the graph below for each of us; I also added a line at my recommended cutoff of 3.75 labels/100m.

```{r plotting, echo=FALSE}
ggplot(data = dist.left, aes(x = threshold, y = 100 - (100 * dist.left / total.dist))) +
  geom_line() +
  geom_vline(xintercept = mikey.freq) +
  geom_vline(xintercept = jon.freq) +
  geom_vline(xintercept = 3.75) +
  xlab('Labels per 100 Meters Threshold') +
  ylab('Percentage to Re-Audit (distance)') +
  theme_bw()
```

And here are some summary statistics for the users:

```{r user.summary.stats, echo=FALSE}
summary(counts %>%
          rename(distance.audited.meters = st_length, total.label.count = label_id) %>%
          select(-user_id))
```

