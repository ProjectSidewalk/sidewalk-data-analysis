---
title: "Re-Audit Analysis"
author: "Mikey Saugstad"
date: "January 17, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(RPostgreSQL)
library(dplyr)
library(ggplot2)
```

```{r connect, echo=FALSE}
pw <- {'sidewalk'}
drv <- dbDriver("PostgreSQL")
con <- dbConnect(drv, dbname = "sidewalk",
                 host = "localhost", port = 5432,
                 user = "sidewalk", password = pw)
rm(pw)
# dbExistsTable(con, "audit_task")
```


```{r reading.data, echo=FALSE}
labels <-
  dbGetQuery(con,
            'SELECT label_id, user_id, label_type_id, completed, audit_task.audit_task_id,
                    street_edge.street_edge_id, ST_LENGTH(ST_TRANSFORM(geom,26918))
            FROM street_edge
            INNER JOIN audit_task
            ON street_edge.street_edge_id = audit_task.street_edge_id
            INNER JOIN label 
            ON audit_task.audit_task_id = label.audit_task_id
            WHERE label.deleted = FALSE')
```

```{r transforming.data, echo=FALSE}
label.counts <-
  labels %>%
  filter(label_type_id != 7) %>%
  mutate(user_id = factor(user_id)) %>%
  # count(user_id)
  group_by(user_id) %>%
  summarize_at(vars(label_id), n_distinct)

# completed.audit.counts <-
#   labels %>%
#   mutate(user_id = factor(user_id)) %>%
#   filter(completed == TRUE) %>%
#   group_by(user_id) %>%
#   summarize_at(vars(audit_task_id), n_distinct)

audit.length <-
  labels %>%
  mutate(user_id = factor(user_id)) %>%
  filter(completed == TRUE) %>%
  group_by(user_id) %>%
  distinct(audit_task_id, .keep_all = TRUE) %>%
  summarize_at(vars(st_length), sum)

counts <-
  audit.length %>%
  inner_join(label.counts, by = 'user_id') %>%
  mutate(labels.per.100m = 100 * label_id / st_length)


streets.after.removal <-
  Vectorize(
    function(labels.per.100m.threshold, labels.threshold) {
      good.users <-
        counts %>%
        filter(labels.per.100m >= labels.per.100m.threshold) %>%
        filter(label_id >= labels.threshold)
      
      new.num.streets <-
        labels %>%
        filter(completed == TRUE) %>%
        filter(user_id %in% good.users$user_id) %>%
        select(street_edge_id) %>%
        n_distinct()
      new.num.streets
    }
  )

num.streets <-
  labels %>%
  filter(completed == TRUE) %>%
  select(street_edge_id) %>%
  n_distinct()

streets.left <-
  data.frame(threshold = seq(0, 10, by = 0.1)) %>%
  mutate(streets.left = streets.after.removal(threshold, 0))
```

This graph shows what percentage of DC we would have to re-audit (in terms of distance), given different labels/100 meter thresholds for users. For example at x = 5.0, I looked at what our completion percentage would be if we removed the audits from all users who have a labeling frequency of less than 5 labels per 100 meters. For reference, Mikey's label frequency is 6.5 labels/100m, and Jon's is 9.6 labels/100m.

I removed the NoSidewalk labels for this analysis, since the labeling style for those are drastically different. With NoSidewalk labels, Mikeys label frequency is 8.7/100m and Jon's is 14.1/100m. Not much changes when keeping those labels, but let me know if you'd like to see that graph as well.
```{r plotting, echo=FALSE}
ggplot(data = streets.left, aes(x = threshold, y = 100 - (100 * streets.left / num.streets))) +
  geom_line() +
  xlab('Labels per 100 Meters Threshold') +
  ylab('Percentage to Re-Audit (distance)') +
  theme_bw()
```

And here are some summary statistics for the users:
```{r user.summary.stats, echo=FALSE}
summary(counts %>%
          rename(distance.audited.meters = st_length, total.label.count = label_id) %>%
          select(-user_id))
```

